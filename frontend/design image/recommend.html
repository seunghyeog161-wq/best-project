<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI ì¶”ì²œ ê²°ê³¼ Â· í”„ë¦¬ë¯¸ì—„ í™”ì´íŠ¸</title>
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="AIê°€ ì—„ì„ í•œ ìƒí’ˆì„ ì„¸ë ¨ëœ í™”ì´íŠ¸ í…Œë§ˆë¡œ ì†Œê°œí•©ë‹ˆë‹¤.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    .badges{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }

/* ë¸Œëœë“œ ë°°ì§€(ëª¨ì–‘ì€ ê¸°ì¡´ .badge ì¬ì‚¬ìš©) */
    .badge.brand-badge { font-weight:700; }
    .badge.brand-badge svg { width:16px; height:16px; }
        :root{
      --bg:#fff;
      --surface:#ffffff;
      --text:#0f172a;     /* Slate-900 */
      --muted:#6b7280;    /* Gray-500 */
      --line:#e5e7eb;     /* Gray-200 */
      --accent:#c5a028;   /* Premium gold */
      --accent-press:#a4881e;
      --shadow:0 10px 30px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.04);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      color:var(--text);
      background:var(--bg);
      letter-spacing:-0.2px;
    }
    /* === ì¶”ì²œ ì¹´ë“œ ê·¸ë¦¬ë“œ === */
    .count-controls{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .count-controls .hint{font-size:12px;color:var(--muted);padding:6px 8px;border:1px dashed var(--line);border-radius:999px;background:linear-gradient(#fff,#f8fafc)}
    .count-controls input[type="range"]{width:min(420px,80vw)}
    .count-controls input[type="number"]{width:80px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}



    .main{
      min-height:100%;
      display:flex; align-items:center; justify-content:center;
      padding:48px 16px; position:relative; isolation:isolate;
    }
    /* ì€ì€í•œ í™”ì´íŠ¸ ê¸€ë¡œìš° (ë°°ê²½ì€ ìˆœë°± ìœ ì§€) */
    .main::before,.main::after{
      content:""; position:absolute; width:540px; height:540px; border-radius:50%;
      filter:blur(60px); opacity:.18; z-index:-1;
    }
    .main::before{ top:-120px; left:-120px; background:radial-gradient(closest-side, #f8fafc, transparent); }
    .main::after{ bottom:-160px; right:-160px; background:radial-gradient(closest-side, #f1f5f9, transparent); }

    .card{
      width:min(960px, 100%);
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:32px 24px 28px;
    }
    .main{
      /* ê¸°ì¡´ ì†ì„± ìœ ì§€ + ì•„ë˜ í•œ ì¤„ë§Œ ì¶”ê°€ */
      flex-direction: column;  /* â¬…ï¸ ì„¸ë¡œë¡œ ìŒ“ì´ê²Œ */
    }
    .results{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 18px;
      margin-top: 18px;
    }


    .header{ display:flex; flex-direction:column; align-items:center; gap:12px; text-align:center; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border:1px solid var(--line); border-radius:999px;
      font-size:12px; font-weight:600; color:#334155; background:linear-gradient(#fff, #f8fafc);
    }
    .badge svg{ width:16px; height:16px }

    h1{ margin:6px 0 0; font-size:clamp(22px, 3vw, 32px); line-height:1.25; letter-spacing:-0.4px; }
    .product{ margin-top:20px; font-size:clamp(20px, 2.6vw, 28px); font-weight:800; }

    .actions{ margin-top:18px; }
    .buy{
      display:inline-flex; align-items:center; gap:10px; cursor:pointer;
      padding:14px 22px; font-weight:700; font-size:16px; color:#fff; text-decoration:none;
      background:var(--accent); border-radius:12px; border:1px solid rgba(0,0,0,.08);
      box-shadow:0 8px 20px rgba(197,160,40,.25);
      transition:transform .12s ease, box-shadow .2s ease, background-color .2s ease, filter .2s ease;
    }
    .buy:hover{ filter:saturate(1.05); transform:translateY(-1px) }
    .buy:active{ background:var(--accent-press); transform:translateY(0) }
    .buy:focus-visible{ outline:4px solid color-mix(in srgb, var(--accent) 30%, transparent) }
    .buy .shine{ position:relative; overflow:hidden }
    .buy .shine::after{
      content:""; position:absolute; inset:0; translate:-120% 0; pointer-events:none;
      background:linear-gradient(120deg, transparent 0 40%, rgba(255,255,255,.55) 50%, transparent 60% 100%);
      animation:shine 3s linear infinite;
    }
    @keyframes shine{ 0%{ translate:-120% 0 } 100%{ translate:120% 0 } }

    .gallery{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:24px; margin-top:28px; }
    figure{
      margin:0; border:1px solid var(--line); border-radius:18px; overflow:hidden; background:#fff;
      box-shadow:0 6px 18px rgba(2,6,23,.04);
      transition:transform .18s ease, box-shadow .18s ease; transform:translateZ(0); perspective:1000px;
    }
    figure:hover{ transform:translateY(-3px); box-shadow:0 12px 28px rgba(2,6,23,.08) }
    img{ display:block; width:100%; height:auto; aspect-ratio:4/3; object-fit:cover; background:#f8fafc }
    figcaption{ padding:10px 12px 12px; font-size:13px; color:#475569; text-align:center; border-top:1px dashed #eef2f7 }

    footer{ margin-top:20px; text-align:center; color:var(--muted); font-size:12px; }

    @media (max-width: 720px){
      .card{ padding:24px 16px 22px; border-radius:20px }
      .gallery{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <main class="main">
    <div id="results" class="results" aria-live="polite"></div>

  </main>

    <script>

    // ì´ë¯¸ì§€ ì—ëŸ¬ ì‹œ ê¸°ë³¸ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ êµì²´(ìˆ¨ê¸°ì§€ ì•ŠìŒ)
    (function () {
    const FALLBACK =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>" +
            "<rect fill='#f8fafc' width='100%' height='100%'/>" +
            "<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#6b7280' font-family='sans-serif' font-size='20'>ì´ë¯¸ì§€ ì—†ìŒ</text>" +
        "</svg>"
        );

    for (const img of document.querySelectorAll('.gallery img')) {
        img.addEventListener('error', () => {
        img.removeAttribute('srcset');
        img.src = FALLBACK;          // ìˆ¨ê¸°ì§€ ë§ê³  ëŒ€ì²´ ì´ë¯¸ì§€ë¡œ
        img.style.objectFit = 'contain';
        img.style.background = '#f8fafc';
        });
    }
    })();
    // ë¶€ë“œëŸ¬ìš´ ë²„íŠ¼ ë“¤ì–´ì˜¤ê¸° ëª¨ì…˜
    window.addEventListener('DOMContentLoaded', () => {
      const btn = document.querySelector('.buy');
      btn?.animate(
        [{ transform: 'translateY(8px)', opacity: 0 }, { transform: 'translateY(0)', opacity: 1 }],
        { duration: 420, easing: 'cubic-bezier(.2,.8,.2,1)', fill: 'both', delay: 120 }
      );
    });

    // ì´ë¯¸ì§€ ì—ëŸ¬ ì‹œ ì¹´ë“œ ìˆ¨ê¹€

  </script>

<script>
let RECO_ALL = [];
let RECO_FETCHED = false;
const DEFAULT_COUNT = Math.max(1, Math.min(50, Number(localStorage.getItem('reco_count')) || 8));

function clampCount(v){ v = Number(v)||1; return Math.max(1, Math.min(50, v)); }
function syncCountInputs(v){
  // ì…ë ¥ ì»¨íŠ¸ë¡¤ì„ ì“°ì§€ ì•Šìœ¼ë¯€ë¡œ no-op (ìˆì–´ë„ ë™ì‘ì— ì§€ì¥ ì—†ìŒ)
  const range = document.getElementById('countRange');
  const num = document.getElementById('countNumber');
  if (range) range.value = v;
  if (num) num.value = v;
}


function getAccessToken() {
  const sp = new URLSearchParams(location.search);
  // âœ… ì¿¼ë¦¬ì—ì„œ ìš°ì„  ìˆ˜ì§‘ (access_token, token, jwt ëª¨ë‘ ì§€ì›)
  const qsToken = sp.get('access_token') || sp.get('token') || sp.get('jwt');
  if (qsToken) {
    const clean = qsToken.replace(/^Bearer\s+/i, '');
    try { localStorage.setItem('access_token', clean); } catch {}
    // ì£¼ì†Œì°½ ì •ë¦¬
    sp.delete('access_token'); sp.delete('token'); sp.delete('jwt');
    const newUrl = location.pathname + (sp.toString() ? `?${sp}` : '') + location.hash;
    history.replaceState(null, '', newUrl);
    return clean;
  }

  // ì €ì¥ì†Œ ìš°ì„ 
  const KEYS = ['access_token','accessToken','jwt','token','id_token','authToken'];
  for (const k of KEYS) {
    const v = localStorage.getItem(k) || sessionStorage.getItem(k);
    if (v) return v.replace(/^Bearer\s+/i,'');
  }

  // (httpOnly ì•„ë‹Œ) ì¿ í‚¤
  const cookie = document.cookie || '';
  for (const k of KEYS) {
    const m = cookie.match(new RegExp('(?:^|;\\s*)' + k + '=([^;]+)'));
    if (m) return decodeURIComponent(m[1]).replace(/^Bearer\s+/i,'');
  }
  return null;
}



function renderResults(n){
  const container = document.getElementById('results');
  if (!container) { console.error("âŒ HTMLì— <div id='results'></div> ì»¨í…Œì´ë„ˆê°€ í•„ìš”í•©ë‹ˆë‹¤!"); return; }

  n = clampCount(n);                     // âœ… 1~50ë¡œ ê°•ì œ
  localStorage.setItem('reco_count', String(n));
  container.innerHTML = "";

  const items = RECO_ALL.slice(0, n);
  if (!items.length) {
    if (RECO_FETCHED) {
      container.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:16px">
        í‘œì‹œí•  ì¶”ì²œì´ ì—†ìŠµë‹ˆë‹¤.
      </div>`;
    }
    return;
  }

  items.forEach(r => {
    const card = document.createElement("section");
    card.className = "card";
    card.innerHTML = `
      <div class="header">
        <span class="badge brand-badge">${r.brand || '-'}</span>
        <h2 data-field="name">${r.name || '-'}</h2>
        <div>${(typeof r.price === 'number') ? r.price.toLocaleString("ko-KR") + "ì›" : (r.price || "-")}</div>
        <div class="actions">
          ${r.link ? `<a class="buy" data-field="link" href="${r.link}" target="_blank" rel="noopener noreferrer">
            <span class="shine">ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°</span>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 17l10-10M9 7h8v8" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>` : ""}
        </div>
      </div>

      <div class="gallery">
        <figure>
          <img src="${API_BASE}${r.img_front || ''}"> alt="ì•ëª¨ìŠµ" loading="lazy" data-image-path="${r.image_path || ''}">
          <figcaption>ì•ëª¨ìŠµ</figcaption>
        </figure>
        <figure>
          <img src="${API_BASE}${r.img_back || ''}">f alt="ë’·ëª¨ìŠµ" loading="lazy" data-image-path="${r.image_path || ''}">
          <figcaption>ë’·ëª¨ìŠµ</figcaption>
        </figure>
      </div>

      <div class="rating" style="margin-top:14px;text-align:center;">
        <div class="starRating" aria-label="ë³„ì  ì£¼ê¸°"></div>
        <div class="ratingResult" style="margin-top:6px;color:#6b7280;"></div>
      </div>
    `;
    container.appendChild(card);
    (() => {
      const FALLBACK =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(
          "<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>" +
            "<rect fill='#f8fafc' width='100%' height='100%'/>" +
            "<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#6b7280' font-family='sans-serif' font-size='20'>ì´ë¯¸ì§€ ì—†ìŒ</text>" +
          "</svg>"
        );

      card.querySelectorAll('img').forEach((img) => {
        const onErr = () => {
          img.removeAttribute('srcset');
          img.src = FALLBACK;
          img.style.objectFit = 'contain';
          img.style.background = '#f8fafc';
        };
        img.addEventListener('error', onErr, { once: true });

        // srcê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜ëª»ëœ ê²½ìš° ì¦‰ì‹œ ëŒ€ì²´
        if (!img.getAttribute('src')) onErr();
      });
    })();
    
  });


  // ìƒˆë¡œ ì¶”ê°€ëœ ì¹´ë“œì— ë³„ì  ì¥ì°© (ì•„ë˜ ë³„ì  IIFEê°€ window.initRatingsë¥¼ ë“±ë¡í•¨)
  if (window.initRatings) window.initRatings(container);
}

function initCountControls(){
  // URL ?n=20 ë˜ëŠ” ?count=20 â†’ localStorage â†’ ê¸°ë³¸ê°’ ìˆœìœ¼ë¡œ ì´ˆê¸° ê°œìˆ˜ ê²°ì •
  const params = new URLSearchParams(location.search);
  const fromUrl = parseInt(params.get('n') || params.get('count'), 10);
  const saved   = parseInt(localStorage.getItem('reco_count') || '', 10);
  const initial = clampCount(!isNaN(fromUrl) ? fromUrl : (!isNaN(saved) ? saved : DEFAULT_COUNT));

  syncCountInputs(initial);
  renderResults(initial);

  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: -, +, ìˆ«ì(ìµœëŒ€ 2ìë¦¬, 0.6ì´ˆ ë‚´ ì—°ì† ì…ë ¥)
  if (!window.__recoKeybindsInstalled) {
    window.__recoKeybindsInstalled = true;

    window.addEventListener('keydown', (e) => {
      const tag = document.activeElement?.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.isContentEditable) return;

      let c = parseInt(localStorage.getItem('reco_count') || initial, 10);
      c = isNaN(c) ? initial : c;

      if (e.key === '-' || e.key === '_') renderResults(clampCount(c - 1));
      if (e.key === '=' || e.key === '+') renderResults(clampCount(c + 1));
    });

    let typed = ''; let timer = null;
    window.addEventListener('keydown', (e) => {
      const tag = document.activeElement?.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.isContentEditable) return;

      if (e.key >= '0' && e.key <= '9') {
        typed = (typed + e.key).slice(-2);
        clearTimeout(timer);
        timer = setTimeout(() => {
          const v = parseInt(typed, 10);
          if (!isNaN(v)) renderResults(clampCount(v));  // âœ… 1~50 ë³´ì¥
          typed = '';
        }, 600);
      }
    });
  }
}

// === ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë‹¨ì¼ IIFE) ===
function showStatus(msg){
  const c = document.getElementById('results');
  if (!c) return;
  c.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#6b7280;padding:16px">
    ${msg}<br><small>Tip: -, +, ìˆ«ìí‚¤(ìµœëŒ€ 2ìë¦¬)ë¡œ ì¹´ë“œ ê°œìˆ˜ ì¡°ì ˆ (1~50)</small>
  </div>`;
}
function normalizeResults(payload){
  if (Array.isArray(payload)) return payload;
  if (payload && Array.isArray(payload.results)) return payload.results;
  if (payload && Array.isArray(payload.items)) return payload.items;
  if (payload && payload.data) {
    if (Array.isArray(payload.data.results)) return payload.data.results;
    if (Array.isArray(payload.data.items)) return payload.data.items;
  }
  return [];
}

(async () => {
  const params = new URLSearchParams(location.search);
  const q = params.get('q');

  // q ì—†ìœ¼ë©´ ì•ˆë‚´ë§Œ í•˜ê³  ë Œë” ê¸ˆì§€
  if (!q) { showStatus("í•„í„°(q)ê°€ ì—†ìŠµë‹ˆë‹¤. ì¶”ì²œ í™”ë©´ì€ í•„í„°ê°€ í¬í•¨ëœ ë§í¬ë¡œ ì ‘ê·¼í•˜ì„¸ìš”."); return; }

  try {
    const TOKEN = getAccessToken();
    const headers = TOKEN ? { 'Authorization': `Bearer ${TOKEN}` } : {};

    const url = `${API_BASE}/api/reco/from_q?q=${encodeURIComponent(q)}`;
    const res = await fetch(url, {
      headers,
      credentials: 'include',
    });
    url.searchParams.set('q', q);



    if (!res.ok) {
      const body = await res.text().catch(()=> '');
      console.warn('from_q failed:', res.status, body);
      showStatus(res.status === 401
        ? 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. (í† í° ì „ì†¡/ë§Œë£Œ í™•ì¸) '
        : 'ì¶”ì²œ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    const data = await res.json();
    RECO_ALL = normalizeResults(data);
    RECO_FETCHED = true;

    // âœ… ì„±ê³µí–ˆì„ ë•Œë§Œ ì´ˆê¸° ë Œë”
    initCountControls();
  } catch (err) {
    console.error('API fetch failed', err);
    showStatus('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    return; // ì‹¤íŒ¨ ì‹œ ë Œë” ê¸ˆì§€
  }
})();

  (() => {
    const TOKEN = getAccessToken();

    function mountStars(starsEl, resultEl, item) {
      function render(active = 0) {
        starsEl.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.textContent = i <= active ? 'â˜…' : 'â˜†';
          star.style.cursor = 'pointer';
          star.style.color  = i <= active ? '#c5a028' : '#d1d5db';
          star.addEventListener('click', async () => {
            render(i); // UI ì¦‰ì‹œ ë°˜ì˜
            try {
 

              const authHeader = TOKEN ? { 'Authorization': `Bearer ${TOKEN}` } : {};
              const F = window.RECO_FILTERS || {};
              const stylesDict = Array.isArray(F.styles)
                ? Object.fromEntries(F.styles.map(k => [k, 1]))
                : (F.styles || null);

              const resp = await fetch(`${API_BASE}/api/reco/feedback/rating`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeader },
                credentials: 'include',
                body: JSON.stringify({
                  item_name: item?.name || 'unknown',
                  link: item?.link || null,
                  image_path: item?.image_path || null,
                  rating: i,

                  // â–¼ ì¶”ì²œ ì»¨í…ìŠ¤íŠ¸ í•¨ê»˜ ì €ì¥
                  rec_gender: F.gender ?? null,                          // "ë‚¨ì„±/ì—¬ì„±/ìƒê´€ì—†ìŒ"(=both)
                  rec_category: F.category ?? null,                      // ë‹¨ì¼ ì¹´í…Œê³ ë¦¬
                  rec_categories: F.categories ?? null,                  // ë‹¤ì¤‘ ì¹´í…Œê³ ë¦¬ ë°°ì—´(ì˜ˆ: ["ìƒì˜","ì•„ìš°í„°"])
                  rec_styles: stylesDict,                                // {í™í•©:0.99, í´ë˜ì‹:0.66, ...}
                  rec_styles_str: window.stylesToShort(stylesDict),      // "í™í•©0.99,í´ë˜ì‹0.66"
                  rec_min_price: (F.budget?.min ?? F.min_price ?? null), // ìµœì†Œ í¬ë§ê°€
                  rec_max_price: (F.budget?.max ?? F.max_price ?? null), // ìµœëŒ€ í¬ë§ê°€
                })
              });
              if (!resp.ok) {
                resultEl.textContent = (resp.status === 401)
                  ? 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
                  : `ë³„ì  ì €ì¥ ì‹¤íŒ¨ (${resp.status})`;
                return;
              }
              resultEl.textContent = `í‰ì : ${i}ì  ê°ì‚¬í•©ë‹ˆë‹¤!`;
              try {
                const ratings = JSON.parse(localStorage.getItem('ratings') || '{}');
                if (item?.name) ratings[item.name] = i;
                localStorage.setItem('ratings', JSON.stringify(ratings));
              } catch {}
            } catch (e) {
              resultEl.textContent = 'ë³„ì  ì €ì¥ ì‹¤íŒ¨ ğŸ˜¥';
              console.error('[rating] fetch failed:', e);
            }
          });
          starsEl.appendChild(star);
        }
      }
      render(0);
    }

    // í•œ ì¹´ë“œì˜ ì•„ì´í…œ ì •ë³´ ì¶”ì¶œ(ë¸Œëœë“œ/ì´ë¦„/ë§í¬/ì´ë¯¸ì§€ ê²½ë¡œ)
    function extractItemFromCard(card) {
      return {
        name: card.querySelector('[data-field="name"]')?.textContent
              || card.querySelector('.product')?.textContent
              || 'unknown',
        link: card.querySelector('[data-field="link"]')?.getAttribute('href')
              || card.querySelector('.buy')?.getAttribute('href')
              || null,
        image_path: card.querySelector('[data-image-path]')?.getAttribute('data-image-path')
              || window.RECO?.image_path
              || null
      };
    }

    // ë¬¸ì„œ(ë˜ëŠ” ìƒˆë¡œ ì¶”ê°€ëœ ë…¸ë“œ) ì•ˆì˜ ëª¨ë“  ì¹´ë“œì— ë³„ì  ì¥ì°©
    function initAllRatings(root = document) {
      // 1) ìƒˆ êµ¬ì¡°: .card ì•ˆì— .starRating / .ratingResult (ê¶Œì¥)
      const starsBoxes = root.querySelectorAll('.card .starRating');
      if (starsBoxes.length) {
        starsBoxes.forEach(starsEl => {
          const card = starsEl.closest('.card');
          const resultEl = card.querySelector('.ratingResult');
          const item = extractItemFromCard(card);
          mountStars(starsEl, resultEl, item);
        });
      } else {
        // 2) êµ¬ êµ¬ì¡°: ë‹¨ì¼ ID (í˜¸í™˜)
        const oldStars  = root.getElementById('starRating');
        const oldResult = root.getElementById('ratingResult');
        if (oldStars && oldResult) {
          const fallbackItem = extractItemFromCard(document);
          mountStars(oldStars, oldResult, fallbackItem);
        }
      }
    }

    // ìƒˆë¡œ DOMì— ì¶”ê°€ë˜ëŠ” ì¹´ë“œë„ ìë™ ì´ˆê¸°í™”
    const mo = new MutationObserver(muts => {
      for (const m of muts) {
        m.addedNodes.forEach(node => {
          if (node.nodeType === 1) initAllRatings(node);
        });
      }
    });
    mo.observe(document.body, { childList: true, subtree: true });

    // ì „ì—­ ìˆ˜ë™ ì´ˆê¸°í™”ë„ ê°€ëŠ¥ (ë Œë” ì§í›„ window.initRatings() í˜¸ì¶œ)
    window.initRatings = initAllRatings;

    // ìµœì´ˆ 1íšŒ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => initAllRatings());
    } else {
      initAllRatings();
    }
  })();
  (function(){
    function b64ToJson(b64){
      try { return JSON.parse(decodeURIComponent(escape(atob(b64)))); } catch(e){}
      return JSON.parse(atob(b64));
    }
    const sp = new URLSearchParams(location.search);
    const q  = sp.get('q');
    window.RECO_FILTERS = null;
    if (q) {
      try {
        const obj = b64ToJson(q);
        window.RECO_FILTERS = obj.filters || obj;
      } catch(e){ console.warn('q decode failed', e); }
    }
    // ìŠ¤íƒ€ì¼ dict â†’ "í™í•©0.99,í´ë˜ì‹0.66" ìš”ì•½ ë¬¸ìì—´
    window.stylesToShort = function(styles){
      if (!styles) return null;
      const s = Array.isArray(styles) ? Object.fromEntries(styles.map(k=>[k,1])) : styles;
      return Object.entries(s).map(([k,v]) => `${k}${Number(v).toFixed(2)}`).join(',');
    };
  })();



</script>

</body>
</html>
